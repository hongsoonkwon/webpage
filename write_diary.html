<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“ Write Diary ğŸ“</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <section class="main-content">
    <footer class="breadcrumb">SK's view &gt; Diary</footer>
    <h2 class="side-bar">ğŸ“ Write Diary ğŸ“</h2>

    <div class="diary-container">
      <input id="diary-title" name="diary-title" type="text" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
      <textarea id="diary-content" name="diary-content" rows="10" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%; padding:12px; font-size:16px; border-radius:8px; border:1px solid #ccc;"></textarea>
      <br><br>
      <button id="save-btn" name="save-btn" class="add-diary-btn">ì €ì¥í•˜ê¸°</button>
    </div>
  </section>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const GAS_URL = "https://script.google.com/macros/s/AKfycbx3oSA0_BMbVyIDwHuOhm5RZO9-X8a5qWpNgp_txtPbWVCTNFC4cs-oQNf8xaf9bbPE/exec";
    
    const titleInput = document.getElementById('diary-title');
    const contentInput = document.getElementById('diary-content');
    const saveBtn = document.getElementById('save-btn');
    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.has('edit') ? parseInt(urlParams.get('edit'), 10) : null;

    function formatDate(date) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      const hh = String(date.getHours()).padStart(2, '0');
      const min = String(date.getMinutes()).padStart(2, '0');
      const ss = String(date.getSeconds()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
    }

    // í¸ì§‘ ëª¨ë“œì¼ ê²½ìš° ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
    if (editId !== null) {
      fetch(GAS_URL)
        .then(res => res.json())
        .then(diaries => {
          const entry = diaries[editId];
          if (entry) {
            titleInput.value = entry.title;
            contentInput.value = entry.content;
          }
        })
        .catch(err => console.error('í¸ì§‘ìš© ì¼ê¸° ë¡œë“œ ì‹¤íŒ¨:', err));
    }

    function saveDiary() {
      const title = titleInput.value.trim();
      const content = contentInput.value.trim();
      if (!title || !content) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      const diaryData = editId !== null
        ? { contents: null } // ì¶”í›„ ì„œë²„ì— bulk update payload
        : { title, content };

      // ì‹ ê·œ ì‘ì„±ì¼ ë•Œ
      if (editId === null) {
        diaryData.time = formatDate(new Date());
      } else {
        // í¸ì§‘ ì‹œ ì „ì²´ ëª©ë¡ì„ ê°€ì ¸ì™€ ìˆ˜ì • í›„ ë‹¤ì‹œ ì „ì†¡
        fetch(GAS_URL)
          .then(res => res.json())
          .then(diaries => {
            diaries[editId].title = title;
            diaries[editId].content = content;
            return fetch(GAS_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ contents: diaries })
            });
          })
          .then(res => res.text())
          .then(() => {
            alert('ìˆ˜ì • ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
            location.href = 'diary.html';
          })
          .catch(err => {
            console.error('ìˆ˜ì • ì‹¤íŒ¨:', err);
            alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
          });
        return;
      }

      // ì‹ ê·œ ì‘ì„±ì¼ ê²½ìš° POST ìš”ì²­
      fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(diaryData)
      })
        .then(res => res.json())
        .then(data => {
          alert(data.message || 'ì¼ê¸°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
          location.href = 'diary.html';
        })
        .catch(err => {
          console.error('ì„œë²„ ì €ì¥ ì‹¤íŒ¨:', err);
          alert('ì„œë²„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        });
    }

    saveBtn.addEventListener('click', saveDiary);
  });
  </script>
</body>
</html>